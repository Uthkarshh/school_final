{% extends "layout.html" %}
{% block content %}
<div class="content-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-key mr-2"></i>Change Password
                        </h3>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="">
                            {{ form.hidden_tag() }}
                            <fieldset class="form-group">
                                <div class="form-group">
                                    {{ form.current_password.label(class="form-control-label") }}
                                    {% if form.current_password.errors %}
                                        {{ form.current_password(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in form.current_password.errors %}
                                                <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        {{ form.current_password(class="form-control form-control-lg") }}
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    {{ form.new_password.label(class="form-control-label") }}
                                    {% if form.new_password.errors %}
                                        {{ form.new_password(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in form.new_password.errors %}
                                                <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        {{ form.new_password(class="form-control form-control-lg") }}
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Password must be at least 8 characters long and contain uppercase, lowercase, and numeric characters.
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    {{ form.confirm_password.label(class="form-control-label") }}
                                    {% if form.confirm_password.errors %}
                                        {{ form.confirm_password(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in form.confirm_password.errors %}
                                                <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        {{ form.confirm_password(class="form-control form-control-lg") }}
                                    {% endif %}
                                </div>
                            </fieldset>
                            
                            <div class="form-group">
                                {{ form.submit(class="btn btn-primary btn-lg") }}
                                <a class="btn btn-secondary btn-lg ml-2" href="{{ url_for('user_bp.account') }}">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add password strength indicator
    const newPasswordField = document.getElementById('new_password');
    const confirmPasswordField = document.getElementById('confirm_password');
    
    if (newPasswordField) {
        // Create password strength indicator
        const strengthIndicator = document.createElement('div');
        strengthIndicator.className = 'password-strength mt-2';
        strengthIndicator.innerHTML = `
            <div class="progress" style="height: 5px;">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted">Password strength: <span class="strength-text">None</span></small>
        `;
        newPasswordField.parentNode.appendChild(strengthIndicator);
        
        newPasswordField.addEventListener('input', function() {
            const password = this.value;
            const progressBar = strengthIndicator.querySelector('.progress-bar');
            const strengthText = strengthIndicator.querySelector('.strength-text');
            
            let strength = 0;
            let strengthLabel = 'Very Weak';
            let strengthColor = 'danger';
            
            if (password.length >= 8) strength += 1;
            if (/[a-z]/.test(password)) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;
            
            switch (strength) {
                case 0:
                case 1:
                    strengthLabel = 'Very Weak';
                    strengthColor = 'danger';
                    break;
                case 2:
                    strengthLabel = 'Weak';
                    strengthColor = 'warning';
                    break;
                case 3:
                    strengthLabel = 'Fair';
                    strengthColor = 'info';
                    break;
                case 4:
                    strengthLabel = 'Good';
                    strengthColor = 'success';
                    break;
                case 5:
                    strengthLabel = 'Strong';
                    strengthColor = 'success';
                    break;
            }
            
            const percentage = (strength / 5) * 100;
            progressBar.style.width = percentage + '%';
            progressBar.className = `progress-bar bg-${strengthColor}`;
            strengthText.textContent = strengthLabel;
            strengthText.className = `text-${strengthColor}`;
        });
    }
    
    // Real-time password confirmation validation
    if (confirmPasswordField && newPasswordField) {
        confirmPasswordField.addEventListener('input', function() {
            const password = newPasswordField.value;
            const confirmPassword = this.value;
            
            if (confirmPassword && password !== confirmPassword) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else if (confirmPassword && password === confirmPassword) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else {
                this.classList.remove('is-invalid', 'is-valid');
            }
        });
    }
});
</script>
{% endblock content %}
