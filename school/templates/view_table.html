{% extends "layout.html" %}
{% block content %}
    <h2>View Table Data</h2>
    <form method="POST" id="dataFilterForm">
        {{ form.csrf_token }}
        <div class="form-group">
            <label for="table_select">Select Table:</label>
            <select class="form-control" id="table_select" name="table_select">
                <option value="student" {% if table_name == 'student' %}selected{% endif %}>Student</option>
                <option value="classdetails" {% if table_name == 'classdetails' %}selected{% endif %}>Class Details</option>
                <option value="fee" {% if table_name == 'fee' %}selected{% endif %}>Fee</option>
                <option value="feebreakdown" {% if table_name == 'feebreakdown' %}selected{% endif %}>Fee Breakdown</option>
                <option value="transport" {% if table_name == 'transport' %}selected{% endif %}>Transport</option>
            </select>
        </div>
        
        <div class="row mt-3 mb-3">
            <div class="col-md-5">
                <div class="form-group">
                    <label for="start_date">Start Date:</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" 
                           value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}">
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-group">
                    <label for="end_date">End Date:</label>
                    <input type="date" class="form-control" id="end_date" name="end_date"
                           value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}">
                </div>
            </div>
        </div>
        
        <div class="d-flex">
            <button type="submit" class="btn btn-primary mr-2">View Data</button>
            <button type="button" id="exportCsvBtn" class="btn btn-success">
                <i class="fas fa-file-csv mr-1"></i> Export to CSV
            </button>
        </div>
    </form>

    {% if data %}
        <div class="mt-4 mb-2">
            <h3>Table: {{ table_name }}</h3>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="thead-dark">
                    <tr>
                        {% for column in data[0].__class__.__table__.columns %}
                            <th>{{ column.name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in data %}
                        <tr>
                            {% for column in row.__class__.__table__.columns %}
                                <td>{{ row[column.name] }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <!-- JavaScript for AJAX-based CSV export -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', function() {
                    // Get form values directly for export
                    const tableSelect = document.getElementById('table_select');
                    const startDateInput = document.getElementById('start_date');
                    const endDateInput = document.getElementById('end_date');
                    
                    const tableName = tableSelect.value;
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    
                    if (!tableName) {
                        alert('Please select a table to export');
                        return;
                    }
                    
                    // Show loading state
                    const originalText = exportCsvBtn.innerHTML;
                    exportCsvBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Preparing download...';
                    exportCsvBtn.disabled = true;
                    
                    // Create a new XMLHttpRequest
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', `/export_csv/${tableName}?start_date=${startDate}&end_date=${endDate}`, true);
                    xhr.responseType = 'blob'; // Important: blob response type for file downloads
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            // Create a blob from the response
                            const blob = new Blob([xhr.response], { type: 'text/csv' });
                            
                            // Get filename from header if available, or use default
                            let filename = xhr.getResponseHeader('X-Filename') || `${tableName}_export.csv`;
                            
                            // Create download link and trigger it
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            
                            // Clean up
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            
                            // Reset button
                            exportCsvBtn.innerHTML = originalText;
                            exportCsvBtn.disabled = false;
                        } else {
                            // Handle error
                            console.error('Download failed');
                            alert('CSV download failed. Please try again.');
                            exportCsvBtn.innerHTML = originalText;
                            exportCsvBtn.disabled = false;
                        }
                    };
                    
                    xhr.onerror = function() {
                        console.error('Download failed');
                        alert('CSV download failed. Please try again.');
                        exportCsvBtn.innerHTML = originalText;
                        exportCsvBtn.disabled = false;
                    };
                    
                    // Send the request
                    xhr.send();
                });
            }
        });
    </script>
{% endblock %}
