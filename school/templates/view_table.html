{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
            <div class="d-flex align-items-center mb-3">
                <i class="fas fa-table text-indigo-600 me-2 fa-lg" aria-hidden="true"></i>
                <h1 class="h4 mb-0">View Table Data</h1>
            </div>
            <hr class="mb-4">

            <form method="POST" id="dataFilterForm" action="{{ url_for('report_bp.view_table') }}">
                {{ form.csrf_token }}
                <fieldset class="form-group">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="table_select" class="form-label">Select Table:</label>
                                <select class="form-control" id="table_select" name="table_select" aria-describedby="table_select_help">
                                    <option value="student" {% if table_name == 'student' %}selected{% endif %}>Student</option>
                                    <option value="classdetails" {% if table_name == 'classdetails' %}selected{% endif %}>Class Details</option>
                                    <option value="fee" {% if table_name == 'fee' %}selected{% endif %}>Fee</option>
                                    <option value="feebreakdown" {% if table_name == 'feebreakdown' %}selected{% endif %}>Fee Breakdown</option>
                                    <option value="transport" {% if table_name == 'transport' %}selected{% endif %}>Transport</option>
                                </select>
                                <small id="table_select_help" class="form-text text-muted">Choose the table to view data from</small>
                            </div>
                        </div>

                        <!-- Fixed PEN Number filter -->
                        <div class="col-md-4">
                            <div class="form-group mb-3" id="penNumberFilterGroup">
                                <label for="pen_num" class="form-label">PEN Number:</label>
                                <input type="text" class="form-control" id="pen_num" name="pen_num"
                                       value="{{ session.get('pen_num', '') }}" aria-describedby="pen_num_help">
                                <small id="pen_num_help" class="form-text text-muted">Filter data by a specific PEN number</small>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="start_date" class="form-label">Start Date:</label>
                                <input type="date" class="form-control" id="start_date" name="start_date"
                                       value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}" aria-describedby="start_date_help">
                                <small id="start_date_help" class="form-text text-muted">Filter records starting from this date</small>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="end_date" class="form-label">End Date:</label>
                                <input type="date" class="form-control" id="end_date" name="end_date"
                                       value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}" aria-describedby="end_date_help">
                                <small id="end_date_help" class="form-text text-muted">Filter records up to this date</small>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <div class="d-flex mt-4">
                    <button type="submit" class="btn btn-accent me-2">
                        <i class="fas fa-eye me-2" aria-hidden="true"></i>View Data
                    </button>
                    <button type="button" id="exportCsvBtn" class="btn btn-success">
                        <i class="fas fa-file-csv me-2" aria-hidden="true"></i>Export to CSV
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if data %}
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Table: {{ table_name | capitalize }}</h2>
                    <span class="badge bg-secondary">{{ data|length }} records</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped mb-0" aria-label="{{ table_name | capitalize }} data">
                        <thead class="thead-dark">
                            <tr>
                                {% for column in data[0].__class__.__table__.columns %}
                                    <th scope="col">{{ column.name }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                                <tr>
                                    {% for column in row.__class__.__table__.columns %}
                                        <td>{{ row[column.name] | string }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {% if pagination %}
            <div class="card-footer bg-white py-3">
                <nav aria-label="Data table pagination">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        {% if pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('report_bp.view_table', page=pagination.prev_num, table_name=table_name) }}" aria-label="Previous page">Previous</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">Previous</span>
                            </li>
                        {% endif %}
                        
                        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if page_num == pagination.page %}
                                <li class="page-item active" aria-current="page">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('report_bp.view_table', page=page_num, table_name=table_name) }}">{{ page_num }}</a>
                                </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">â€¦</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('report_bp.view_table', page=pagination.next_num, table_name=table_name) }}" aria-label="Next page">Next</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">Next</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>

        <!-- Add Edit Record functionality -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body p-4">
                <h3 class="h5 card-title mb-3">Edit Record</h3>
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <select id="editRowSelect" class="form-control" aria-label="Select record to edit" aria-describedby="edit-record-help">
                                <option value="">-- Select a record to edit --</option>
                                {% for row in data %}
                                    {% if table_name == 'student' %}
                                        <option value="{{ row.pen_num }}">PEN: {{ row.pen_num }} - {{ row.student_name }}</option>
                                    {% elif table_name == 'classdetails' %}
                                        <option value="{{ row.pen_num }},{{ row.year }}">PEN: {{ row.pen_num }} - Year: {{ row.year }} - Class: {{ row.current_class }}{{ row.section }}</option>
                                    {% elif table_name == 'fee' %}
                                        <option value="{{ row.pen_num }},{{ row.year }}">PEN: {{ row.pen_num }} - Year: {{ row.year }} - School Fee: {{ row.school_fee }}</option>
                                    {% elif table_name == 'feebreakdown' %}
                                        <option value="{{ row.pen_num }},{{ row.year }},{{ row.fee_type }},{{ row.term }},{{ row.payment_type }}">
                                            PEN: {{ row.pen_num }} - {{ row.fee_type }} ({{ row.term }}) - Paid: {{ row.paid }}
                                        </option>
                                    {% elif table_name == 'transport' %}
                                        <option value="{{ row.transport_id }}">ID: {{ row.transport_id }} - {{ row.pick_up_point }} (Route: {{ row.route_number }})</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <button id="editRecordBtn" class="btn btn-indigo" aria-label="Edit selected record">
                                <i class="fas fa-edit me-2" aria-hidden="true"></i>Edit Record
                            </button>
                        </div>
                        <small id="edit-record-help" class="form-text text-muted">Select a record from the table above to edit its details</small>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- NEW FEE SUMMARY SECTION -->
    <div class="card border-0 shadow-sm mt-4">
        <div class="card-body p-4">
            <div class="d-flex align-items-center mb-3">
                <i class="fas fa-chart-bar text-success me-2 fa-lg" aria-hidden="true"></i>
                <h2 class="h4 mb-0">Fee Summary Report</h2>
            </div>
            <hr class="mb-4">

            <form method="POST" id="feeSummaryForm" action="{{ url_for('report_bp.fee_summary_report') }}">
                {{ form.csrf_token }}
                <fieldset class="form-group">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label for="summary_pen_num" class="form-label">PEN Number:</label>
                                <input type="text" class="form-control" id="summary_pen_num" name="summary_pen_num"
                                       value="{{ request.form.get('summary_pen_num', '') }}" 
                                       aria-describedby="summary_pen_help">
                                <small id="summary_pen_help" class="form-text text-muted">Leave blank for all students</small>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label for="summary_class" class="form-label">Class:</label>
                                <select class="form-control" id="summary_class" name="summary_class" aria-describedby="summary_class_help">
                                    <option value="">All Classes</option>
                                    {% set valid_classes = ["Nursery", "LKG", "UKG", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"] %}
                                    {% for class_name in valid_classes %}
                                        <option value="{{ class_name }}" {% if request.form.get('summary_class') == class_name %}selected{% endif %}>
                                            {% if class_name in ["Nursery", "LKG", "UKG"] %}
                                                {{ class_name }}
                                            {% else %}
                                                Class {{ class_name }}
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small id="summary_class_help" class="form-text text-muted">Filter by student class</small>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label for="summary_year" class="form-label">Academic Year:</label>
                                <select class="form-control" id="summary_year" name="summary_year" aria-describedby="summary_year_help">
                                    <option value="">All Years</option>
                                    {% for year in range(2020, 2030) %}
                                        <option value="{{ year }}" {% if request.form.get('summary_year') == year|string %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                                <small id="summary_year_help" class="form-text text-muted">Filter by academic year</small>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label for="summary_start_date" class="form-label">Start Date:</label>
                                <input type="date" class="form-control" id="summary_start_date" name="summary_start_date"
                                       value="{{ request.form.get('summary_start_date', '') }}" 
                                       aria-describedby="summary_start_help">
                                <small id="summary_start_help" class="form-text text-muted">Filter from this date</small>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label for="summary_end_date" class="form-label">End Date:</label>
                                <input type="date" class="form-control" id="summary_end_date" name="summary_end_date"
                                       value="{{ request.form.get('summary_end_date', '') }}" 
                                       aria-describedby="summary_end_help">
                                <small id="summary_end_help" class="form-text text-muted">Filter until this date</small>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <div class="d-flex mt-4">
                    <button type="submit" name="action" value="view" class="btn btn-success me-2">
                        <i class="fas fa-eye me-2" aria-hidden="true"></i>View Fee Summary
                    </button>
                    <button type="submit" name="action" value="download" class="btn btn-primary">
                        <i class="fas fa-download me-2" aria-hidden="true"></i>Download CSV
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Fee Summary Results Display -->
    {% if fee_summary_data %}
    <div class="card border-0 shadow-sm mt-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Fee Summary Report</h2>
                <span class="badge bg-success">{{ fee_summary_data|length }} records</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0" aria-label="Fee Summary data">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">PEN Number</th>
                            <th scope="col">Student Name</th>
                            <th scope="col">Class</th>
                            <th scope="col">Academic Year</th>
                            <th scope="col">Total School Fee</th>
                            <th scope="col">Total Transport Fee</th>
                            <th scope="col">Total Application Fee</th>
                            <th scope="col">School Fee Paid</th>
                            <th scope="col">Transport Fee Paid</th>
                            <th scope="col">Application Fee Paid</th>
                            <th scope="col">Total Outstanding</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in fee_summary_data %}
                            <tr>
                                <td>{{ row.pen_num }}</td>
                                <td>{{ row.student_name }}</td>
                                <td>{{ row.current_class }}-{{ row.section }}</td>
                                <td>{{ row.year }}</td>
                                <td>â‚¹{{ "{:,.0f}".format(row.total_school_fee) }}</td>
                                <td>â‚¹{{ "{:,.0f}".format(row.total_transport_fee) }}</td>
                                <td>â‚¹{{ "{:,.0f}".format(row.total_application_fee) }}</td>
                                <td>â‚¹{{ "{:,.0f}".format(row.school_fee_paid) }}</td>
                                <td>â‚¹{{ "{:,.0f}".format(row.transport_fee_paid) }}</td>
                                <td>â‚¹{{ "{:,.0f}".format(row.application_fee_paid) }}</td>
                                <td class="{% if row.total_outstanding > 0 %}text-danger fw-bold{% else %}text-success{% endif %}">
                                    â‚¹{{ "{:,.0f}".format(row.total_outstanding) }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-secondary">
                        <tr class="fw-bold">
                            <td colspan="4">TOTALS:</td>
                            <td>â‚¹{{ "{:,.0f}".format(fee_summary_data|sum(attribute='total_school_fee')) }}</td>
                            <td>â‚¹{{ "{:,.0f}".format(fee_summary_data|sum(attribute='total_transport_fee')) }}</td>
                            <td>â‚¹{{ "{:,.0f}".format(fee_summary_data|sum(attribute='total_application_fee')) }}</td>
                            <td>â‚¹{{ "{:,.0f}".format(fee_summary_data|sum(attribute='school_fee_paid')) }}</td>
                            <td>â‚¹{{ "{:,.0f}".format(fee_summary_data|sum(attribute='transport_fee_paid')) }}</td>
                            <td>â‚¹{{ "{:,.0f}".format(fee_summary_data|sum(attribute='application_fee_paid')) }}</td>
                            <td class="text-danger">â‚¹{{ "{:,.0f}".format(fee_summary_data|sum(attribute='total_outstanding')) }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Help Card -->
    <div class="card bg-gray-50 border-0 shadow-sm mt-4">
        <div class="card-body p-3">
            <div class="d-flex">
                <div class="icon-circle bg-indigo-100 text-indigo-600 me-3" aria-hidden="true">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div>
                    <h2 class="h5 card-title mb-2">Data Viewing and Exporting</h2>
                    <p class="card-text mb-0 text-slate-600">
                        This page allows you to view and export data from various tables within the school database. You can filter the data by table, PEN number, and date range. Use the Fee Summary Report section to get consolidated fee information across students.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tips Card -->
    <div class="card bg-amber-50 border-0 shadow-sm mt-3 mb-3">
        <div class="card-body p-3">
            <div class="d-flex align-items-center">
                <i class="fas fa-star text-amber-600 me-2" aria-hidden="true"></i>
                <div>
                    <h3 class="h6 mb-1">Tips for Viewing Data</h3>
                    <ul class="text-slate-600 small mb-0 ps-3">
                        <li>Use the table selection to switch between different data sets.</li>
                        <li>Apply filters to narrow down the data to the specific records you need.</li>
                        <li>The export button allows you to download the currently viewed data as a CSV file.</li>
                        <li>Select a specific record to edit by using the edit record functionality at the bottom of the page.</li>
                        <li>Use pagination controls to navigate through large data sets.</li>
                        <li><strong>New:</strong> Use the Fee Summary Report to get consolidated fee information with totals and outstanding amounts.</li>
                        <li><strong>Fee Report:</strong> All filters are optional - leave blank to include all values for that filter.</li>
                        <li><strong>Class System:</strong> The system now supports Nursery, LKG, UKG, and Classes I-X for flexible grade management.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for AJAX-based CSV export and table filtering -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableSelect = document.getElementById('table_select');
        const penNumberFilterGroup = document.getElementById('penNumberFilterGroup');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const editRecordBtn = document.getElementById('editRecordBtn');
        const editRowSelect = document.getElementById('editRowSelect');
        
        // Function to toggle PEN number filter visibility
        function togglePenNumberFilter() {
            if (tableSelect.value === 'transport') {
                penNumberFilterGroup.style.display = 'none';
            } else {
                penNumberFilterGroup.style.display = 'block';
            }
        }
        
        // Set initial visibility based on selected table
        togglePenNumberFilter();
        
        // Toggle visibility when table selection changes
        if (tableSelect) {
            tableSelect.addEventListener('change', togglePenNumberFilter);
        }
        
        // Handle edit record button click
        if (editRecordBtn && editRowSelect) {
            editRecordBtn.addEventListener('click', function() {
                const selectedValue = editRowSelect.value;
                if (!selectedValue) {
                    alert('Please select a record to edit');
                    return;
                }
                
                const table = '{{ table_name }}';
                let url = '';
                
                if (table === 'student') {
                    url = `{{ url_for('student_bp.student_form') }}?edit_pen_num=${selectedValue}`;
                } else if (table === 'classdetails') {
                    const [pen_num, year] = selectedValue.split(',');
                    url = `{{ url_for('student_bp.class_details_form') }}?edit_pen_num=${pen_num}&edit_year=${year}`;
                } else if (table === 'fee') {
                    const [pen_num, year] = selectedValue.split(',');
                    url = `{{ url_for('fee_bp.fee_form') }}?edit_pen_num=${pen_num}&edit_year=${year}`;
                } else if (table === 'feebreakdown') {
                    const [pen_num, year, fee_type, term, payment_type] = selectedValue.split(',');
                    url = `{{ url_for('fee_bp.fee_breakdown_form') }}?edit_pen_num=${pen_num}&edit_year=${year}&edit_fee_type=${encodeURIComponent(fee_type)}&edit_term=${encodeURIComponent(term)}&edit_payment_type=${encodeURIComponent(payment_type)}`;
                } else if (table === 'transport') {
                    url = `{{ url_for('transport_bp.transport_form') }}?edit_id=${selectedValue}`;
                }
                
                if (url) {
                    window.location.href = url;
                }
            });
        }
        
        if (exportCsvBtn) {
            exportCsvBtn.addEventListener('click', function() {
                // Get form values directly for export
                const startDateInput = document.getElementById('start_date');
                const endDateInput = document.getElementById('end_date');
                const penNumInput = document.getElementById('pen_num');
                
                const tableName = tableSelect.value;
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const penNum = penNumInput.value;
                
                if (!tableName) {
                    alert('Please select a table to export');
                    return;
                }
                
                // Show loading state
                const originalText = exportCsvBtn.innerHTML;
                exportCsvBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2" aria-hidden="true"></i> Preparing download...';
                exportCsvBtn.disabled = true;
                
                // Build URL with all filters
                let exportUrl = `{{ url_for('report_bp.export_csv', table_name='TABLE_PLACEHOLDER') }}`.replace('TABLE_PLACEHOLDER', tableName);
                
                // Add query parameters
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (penNum && tableName !== 'transport') params.append('pen_num', penNum);
                
                // Add parameters to URL if we have any
                if (params.toString()) {
                    exportUrl += '?' + params.toString();
                }
                
                // Create a new XMLHttpRequest
                const xhr = new XMLHttpRequest();
                xhr.open('GET', exportUrl, true);
                xhr.responseType = 'blob'; // Important: blob response type for file downloads
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        // Create a blob from the response
                        const blob = new Blob([xhr.response], { type: 'text/csv' });
                        
                        // Get filename from header if available, or use default
                        let filename = xhr.getResponseHeader('X-Filename') || `${tableName}_export.csv`;
                        
                        // Create download link and trigger it
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Reset button
                        exportCsvBtn.innerHTML = originalText;
                        exportCsvBtn.disabled = false;
                    } else {
                        // Handle error
                        console.error('Download failed');
                        alert('CSV download failed. Please try again.');
                        exportCsvBtn.innerHTML = originalText;
                        exportCsvBtn.disabled = false;
                    }
                };
                
                xhr.onerror = function() {
                    console.error('Download failed');
                    alert('CSV download failed. Please try again.');
                    exportCsvBtn.innerHTML = originalText;
                    exportCsvBtn.disabled = false;
                };
                
                // Add timeout handling
                xhr.timeout = 30000; // 30 seconds
                xhr.ontimeout = function() {
                    console.error('Download request timed out');
                    alert('CSV download request timed out. The file might be too large or the server is busy. Please try again or use more filters to reduce the data size.');
                    exportCsvBtn.innerHTML = originalText;
                    exportCsvBtn.disabled = false;
                };
                
                // Send the request
                xhr.send();
            });
        }
    });
</script>
{% endblock content %}
